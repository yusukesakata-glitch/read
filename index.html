<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª­æ›¸è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <style>
        :root {
            --bg-color: #fffaf5;
            --primary-orange: #e67e22;
            --primary-green: #27ae60;
            --accent-yellow: #f1c40f;
            --text-main: #333;
            --text-sub: #888;
            --card-bg: #ffffff;
            --border-radius: 16px;
        }

        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 15px; color: var(--text-main);
            padding-bottom: 80px;
        }

        /* --- UI Components --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 22px; margin: 0; }
        .header-btns { display: flex; gap: 8px; }

        .btn-icon { width: 40px; height: 40px; border-radius: 10px; border: none; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-add { background: var(--primary-orange); color: white; padding: 0 15px; border-radius: 10px; border: none; font-weight: bold; height: 40px; cursor: pointer; }

        /* Goal Card */
        .goal-card { background: #e8f8f0; padding: 15px; border-radius: var(--border-radius); margin-bottom: 15px; }
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; color: #2d5a27; }
        .progress-bg { background: white; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { background: #82e9a8; height: 100%; transition: width 0.3s; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stats-sub { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 12px; border-radius: var(--border-radius); text-align: center; }
        .stat-num { display: block; font-size: 20px; font-weight: bold; }
        .stat-label { font-size: 11px; color: var(--text-sub); }

        /* Tabs & Search */
        .search-bar { width: 100%; padding: 12px; border: 1.5px solid #ddd; border-radius: 12px; box-sizing: border-box; margin-bottom: 15px; }
        .search-bar:focus { border-color: var(--accent-yellow); outline: none; }
        
        .sort-trigger { width: 100%; padding: 12px; background: #eee; border-radius: 12px; border: none; text-align: left; margin-bottom: 15px; position: relative; cursor: pointer; }
        .sort-trigger::after { content: 'â–¼'; position: absolute; right: 15px; font-size: 12px; color: #666; }

        .category-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; white-space: nowrap; }
        .tab { padding: 8px 16px; background: white; border-radius: 20px; border: 1px solid #eee; font-size: 13px; cursor: pointer; }
        .tab.active { background: var(--primary-orange); color: white; border-color: var(--primary-orange); }

        /* Book Grid */
        .book-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .book-card { background: white; border-radius: var(--border-radius); overflow: hidden; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .book-cover-placeholder { height: 150px; background: #eaecf0; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #adb5bd; }
        .book-info { padding: 10px; }
        .book-tag { font-size: 10px; background: #fff3e0; color: #e67e22; padding: 2px 6px; border-radius: 10px; }
        .book-title { font-size: 13px; font-weight: bold; margin: 5px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .book-author { font-size: 11px; color: var(--text-sub); }
        .book-status-select { width: 100%; margin-top: 8px; padding: 5px; border-radius: 8px; border: 1px solid #ddd; font-size: 12px; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: white; color: #e74c3c; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; position: relative; max-height: 85vh; overflow-y: auto; }
        .modal-title { font-weight: bold; font-size: 18px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #eee; box-sizing: border-box; }
        .form-group input:focus { border-color: var(--accent-yellow); outline: none; }
        
        .segmented-control { display: flex; gap: 5px; background: #f0f0f0; padding: 4px; border-radius: 12px; }
        .segment { flex: 1; text-align: center; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .segment.active { background: #3b82f6; color: white; }

        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm { flex: 2; background: var(--primary-orange); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; }
        .btn-cancel { flex: 1; background: #eee; border: none; padding: 12px; border-radius: 12px; }
        .btn-save-green { width: 100%; background: var(--primary-green); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; }

        /* Star Rating */
        .stars { display: flex; gap: 5px; font-size: 30px; color: #ddd; cursor: pointer; margin: 10px 0; }
        .stars .active { color: #f1c40f; }

    </style>
</head>
<body>

<div class="header">
    <h1>èª­æ›¸è¨˜éŒ²</h1>
    <div class="header-btns">
        <button class="btn-icon" onclick="openModal('modal-goal')" style="color:var(--primary-green)">ğŸ¯</button>
        <button class="btn-icon" style="color: #9b59b6;">â†“</button>
        <button class="btn-add" onclick="openModal('modal-add')">ï¼‹ è¿½åŠ </button>
    </div>
</div>

<div class="goal-card" onclick="openModal('modal-goal')">
    <div class="goal-header">
        <span>ğŸ¯ å¹´é–“ç›®æ¨™: <span id="display-target">100</span>å†Š</span>
        <span id="display-progress-text">0/100 (0%)</span>
    </div>
    <div class="progress-bg"><div id="display-progress-fill" class="progress-fill" style="width: 0%"></div></div>
</div>

<div class="stats-grid">
    <div class="stat-box" style="background:#e8f8f0"><span class="stat-num" id="stat-read" style="color:#27ae60">0</span><span class="stat-label">èª­äº†</span></div>
    <div class="stat-box" style="background:#eef2ff"><span class="stat-num" id="stat-reading" style="color:#3b82f6">0</span><span class="stat-label">èª­æ›¸ä¸­</span></div>
    <div class="stat-box" style="background:#f8f9fa"><span class="stat-num" id="stat-want">0</span><span class="stat-label">èª­ã¿ãŸã„</span></div>
</div>
<div class="stats-sub">
    <div class="stat-box" style="background:#f5f0ff"><span class="stat-num" id="stat-pages" style="color:#9b59b6">0</span><span class="stat-label">ç·ãƒšãƒ¼ã‚¸æ•°</span></div>
    <div class="stat-box" style="background:#fff0f5"><span class="stat-num" id="stat-fav" style="color:#e91e63">0</span><span class="stat-label">ãŠæ°—ã«å…¥ã‚Š</span></div>
</div>

<input type="text" class="search-bar" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…ã§æ¤œç´¢..." oninput="renderBooks()">

<button class="sort-trigger" id="sort-label" onclick="openModal('modal-sort')">ç™»éŒ²æ—¥é †</button>

<div class="category-tabs" id="category-tabs">
    <div class="tab active" onclick="setCategory('å…¨ã¦')">å…¨ã¦</div>
    <div class="tab" onclick="setCategory('å°èª¬')">å°èª¬</div>
    <div class="tab" onclick="setCategory('ãƒ“ã‚¸ãƒã‚¹')">ãƒ“ã‚¸ãƒã‚¹</div>
    <div class="tab" onclick="setCategory('æŠ€è¡“æ›¸')">æŠ€è¡“æ›¸</div>
    <div class="tab" onclick="setCategory('ã‚¨ãƒƒã‚»ã‚¤')">ã‚¨ãƒƒã‚»ã‚¤</div>
    <div class="tab" onclick="setCategory('ãã®ä»–')">ãã®ä»–</div>
    <div class="tab">+ è¿½åŠ </div>
</div>

<div class="book-grid" id="book-grid"></div>

<div id="modal-add" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">æœ¬ã‚’è¿½åŠ </div>
        <div class="form-group">
            <label>ã‚¿ã‚¤ãƒˆãƒ« <span style="color:red">*</span></label>
            <input type="text" id="add-title" placeholder="ä¾‹ï¼šãƒãƒ«ã‚¦ã‚§ã‚¤ã®æ£®">
        </div>
        <div class="form-group">
            <label>è‘—è€… <span style="color:red">*</span></label>
            <input type="text" id="add-author" placeholder="ä¾‹ï¼šæ‘ä¸Šæ˜¥æ¨¹">
        </div>
        <div style="display:flex; gap:10px">
            <div class="form-group" style="flex:1">
                <label>ãƒšãƒ¼ã‚¸æ•°</label>
                <input type="number" id="add-pages" placeholder="350">
            </div>
            <div class="form-group" style="flex:1">
                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="add-category">
                    <option>ãã®ä»–</option><option>å°èª¬</option><option>ãƒ“ã‚¸ãƒã‚¹</option><option>æŠ€è¡“æ›¸</option><option>ã‚¨ãƒƒã‚»ã‚¤</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <div class="segmented-control" id="add-status">
                <div class="segment active" data-val="reading">èª­æ›¸ä¸­</div>
                <div class="segment" data-val="want">èª­ã¿ãŸã„</div>
                <div class="segment" data-val="read">èª­äº†</div>
            </div>
        </div>
        <div class="form-group">
            <label>è¡¨ç´™ç”»åƒURLï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="add-image" placeholder="ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚OK">
        </div>
        <div class="modal-footer">
            <button class="btn-confirm" onclick="saveBook()">è¿½åŠ </button>
            <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="modal-goal" class="modal-overlay">
    <div class="modal" style="text-align:center">
        <div class="modal-title">å¹´é–“ç›®æ¨™</div>
        <div class="form-group">
            <input type="number" id="input-goal" value="100" style="text-align:center; font-size:20px">
        </div>
        <button class="btn-save-green" onclick="saveGoal()">ä¿å­˜</button>
    </div>
</div>

<div id="modal-sort" class="modal-overlay">
    <div class="modal">
        <div class="form-group" style="margin:0">
            <div style="padding:15px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between" onclick="setSort('ç™»éŒ²æ—¥é †')">ç™»éŒ²æ—¥é † <span id="check-date">â—</span></div>
            <div style="padding:15px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between" onclick="setSort('ã‚¿ã‚¤ãƒˆãƒ«é †')">ã‚¿ã‚¤ãƒˆãƒ«é † <span id="check-title"></span></div>
            <div style="padding:15px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between" onclick="setSort('è‘—è€…é †')">è‘—è€…é † <span id="check-author"></span></div>
            <div style="padding:15px 0; display:flex; justify-content:space-between" onclick="setSort('è©•ä¾¡é †')">è©•ä¾¡é † <span id="check-rating"></span></div>
        </div>
    </div>
</div>

<div id="modal-detail" class="modal-overlay">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <div id="detail-header-title" style="font-weight:bold; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; width:70%"></div>
            <div>
                <button class="btn-icon" style="display:inline-block; font-size:14px">âœ</button>
                <button class="btn-icon" onclick="closeModal()" style="display:inline-block; font-size:14px">âœ•</button>
            </div>
        </div>
        <div style="background:#f8f9fa; padding:15px; border-radius:15px; margin-bottom:15px">
            <h3 id="detail-title" style="margin:0 0 10px 0"></h3>
            <div style="font-size:13px; color:#555; line-height:1.8">
                <div>è‘—è€…: <span id="detail-author"></span></div>
                <div>ãƒšãƒ¼ã‚¸æ•°: <span id="detail-pages"></span></div>
                <div>ã‚«ãƒ†ã‚´ãƒª: <span id="detail-category"></span></div>
                <div>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="detail-status"></span></div>
            </div>
        </div>
        <label style="font-size:13px; font-weight:bold">è©•ä¾¡</label>
        <div class="stars" id="detail-stars">
            <span data-idx="1">â˜…</span><span data-idx="2">â˜…</span><span data-idx="3">â˜…</span><span data-idx="4">â˜…</span><span data-idx="5">â˜…</span>
        </div>
        <div style="background:#f8f9fa; padding:10px; border-radius:10px; margin-bottom:15px; display:flex; align-items:center; gap:10px">
            <input type="checkbox" id="detail-fav"> <span style="font-size:20px">â™¡</span> ãŠæ°—ã«å…¥ã‚Š
        </div>
        <label style="font-size:13px; font-weight:bold">ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
        <textarea id="detail-memo" rows="4" style="width:100%; border-radius:12px; border:1px solid #eee; padding:10px; margin-top:5px" placeholder="ã“ã®æœ¬ã®æ„Ÿæƒ³ã‚„ãƒ¡ãƒ¢ã‚’æ›¸ã..."></textarea>
        <button class="btn-save-green" style="margin-top:15px" onclick="saveDetail()">ä¿å­˜</button>
    </div>
</div>

<script>
    let books = JSON.parse(localStorage.getItem('books_v2')) || [];
    let goal = localStorage.getItem('goal_v2') || 100;
    let currentCategory = 'å…¨ã¦';
    let currentSort = 'ç™»éŒ²æ—¥é †';
    let editingId = null;

    // åˆæœŸåŒ–
    window.onload = () => {
        updateDashboard();
        renderBooks();
        setupSegments();
    };

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal() { 
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); 
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼‰ã®æŒ™å‹•
    function setupSegments() {
        document.querySelectorAll('.segment').forEach(seg => {
            seg.addEventListener('click', function() {
                this.parentElement.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }

    function saveGoal() {
        goal = document.getElementById('input-goal').value;
        localStorage.setItem('goal_v2', goal);
        updateDashboard();
        closeModal();
    }

    function saveBook() {
        const title = document.getElementById('add-title').value;
        const author = document.getElementById('add-author').value;
        if(!title || !author) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨è‘—è€…ã¯å¿…é ˆã§ã™");

        const newBook = {
            id: Date.now(),
            title,
            author,
            pages: document.getElementById('add-pages').value || 0,
            category: document.getElementById('add-category').value,
            status: document.querySelector('#add-status .active').dataset.val,
            image: document.getElementById('add-image').value,
            rating: 0,
            isFavorite: false,
            memo: '',
            createdAt: new Date().toISOString()
        };

        books.push(newBook);
        saveAndRefresh();
        closeModal();
        // Clear inputs
        document.getElementById('add-title').value = '';
        document.getElementById('add-author').value = '';
    }

    function saveAndRefresh() {
        localStorage.setItem('books_v2', JSON.stringify(books));
        updateDashboard();
        renderBooks();
    }

    function updateDashboard() {
        const readCount = books.filter(b => b.status === 'read').length;
        document.getElementById('display-target').innerText = goal;
        document.getElementById('stat-read').innerText = readCount;
        document.getElementById('stat-reading').innerText = books.filter(b => b.status === 'reading').length;
        document.getElementById('stat-want').innerText = books.filter(b => b.status === 'want').length;
        document.getElementById('stat-pages').innerText = books.reduce((sum, b) => sum + Number(b.pages), 0);
        document.getElementById('stat-fav').innerText = books.filter(b => b.isFavorite).length;

        const percent = Math.min(Math.round((readCount / goal) * 100), 100);
        document.getElementById('display-progress-fill').style.width = percent + '%';
        document.getElementById('display-progress-text').innerText = `${readCount}/${goal} (${percent}%)`;
    }

    function setCategory(cat) {
        currentCategory = cat;
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.toggle('active', t.innerText === cat);
        });
        renderBooks();
    }

    function setSort(type) {
        currentSort = type;
        document.getElementById('sort-label').innerText = type;
        renderBooks();
        closeModal();
    }

    function renderBooks() {
        const grid = document.getElementById('book-grid');
        const query = document.querySelector('.search-bar').value.toLowerCase();
        grid.innerHTML = '';

        let filtered = books.filter(b => {
            const matchCat = (currentCategory === 'å…¨ã¦' || b.category === currentCategory);
            const matchSearch = (b.title.toLowerCase().includes(query) || b.author.toLowerCase().includes(query));
            return matchCat && matchSearch;
        });

        // Sorting
        if(currentSort === 'ã‚¿ã‚¤ãƒˆãƒ«é †') filtered.sort((a,b) => a.title.localeCompare(b.title));
        else if(currentSort === 'è‘—è€…é †') filtered.sort((a,b) => a.author.localeCompare(b.author));
        else if(currentSort === 'è©•ä¾¡é †') filtered.sort((a,b) => b.rating - a.rating);
        else filtered.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

        filtered.forEach(book => {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.onclick = () => openDetail(book.id);
            card.innerHTML = `
                <button class="delete-btn" onclick="deleteBook(event, ${book.id})">ğŸ—‘</button>
                <div class="book-cover-placeholder">${book.image ? `<img src="${book.image}" style="width:100%;height:100%;object-fit:cover">` : 'ğŸ“–'}</div>
                <div class="book-info">
                    <span class="book-tag">${book.category}</span> <span style="font-size:10px">â­ ${book.rating}</span>
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">${book.author}</div>
                    <select class="book-status-select" onclick="event.stopPropagation()" onchange="updateStatus(${book.id}, this.value)">
                        <option value="reading" ${book.status==='reading'?'selected':''}>èª­æ›¸ä¸­</option>
                        <option value="want" ${book.status==='want'?'selected':''}>èª­ã¿ãŸã„</option>
                        <option value="read" ${book.status==='read'?'selected':''}>èª­äº†</option>
                    </select>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function deleteBook(e, id) {
        e.stopPropagation();
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            books = books.filter(b => b.id !== id);
            saveAndRefresh();
        }
    }

    function updateStatus(id, newStatus) {
        const book = books.find(b => b.id === id);
        book.status = newStatus;
        saveAndRefresh();
    }

    // è©³ç´°ç”»é¢ã®å‡¦ç†
    function openDetail(id) {
        const book = books.find(b => b.id === id);
        editingId = id;
        document.getElementById('detail-header-title').innerText = book.title;
        document.getElementById('detail-title').innerText = book.title;
        document.get
