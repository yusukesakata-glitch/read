<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª­æ›¸è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <style>
        :root {
            --bg-color: #fffaf5;
            --primary-orange: #e67e22;
            --primary-green: #27ae60;
            --accent-yellow: #f1c40f;
            --text-main: #333;
            --text-sub: #888;
            --blue-active: #3b82f6;
            --card-bg: #ffffff;
            --border-radius: 16px;
        }

        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 15px; color: var(--text-main);
            padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI Components --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 22px; margin: 0; }
        .header-btns { display: flex; gap: 8px; }

        .btn-icon { width: 40px; height: 40px; border-radius: 10px; border: none; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-add { background: var(--primary-orange); color: white; padding: 0 15px; border-radius: 10px; border: none; font-weight: bold; height: 40px; cursor: pointer; }

        /* Goal Card */
        .goal-card { background: #e8f8f0; padding: 15px; border-radius: var(--border-radius); margin-bottom: 15px; cursor: pointer; }
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; color: #2d5a27; }
        .progress-bg { background: white; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { background: #82e9a8; height: 100%; transition: width 0.3s; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .stats-sub { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 12px; border-radius: var(--border-radius); text-align: center; }
        .stat-num { display: block; font-size: 20px; font-weight: bold; }
        .stat-label { font-size: 11px; color: var(--text-sub); }

        /* Search & Sort */
        .search-bar { width: 100%; padding: 12px; border: 1.5px solid #ddd; border-radius: 12px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
        .search-bar:focus { border-color: var(--accent-yellow); outline: none; }
        
        .sort-trigger { width: 100%; padding: 12px; background: #eee; border-radius: 12px; border: 1.5px solid transparent; text-align: left; margin-bottom: 15px; position: relative; cursor: pointer; font-size: 14px; }
        .sort-trigger::after { content: 'â–¼'; position: absolute; right: 15px; font-size: 12px; color: #666; }
        .sort-active-border { border-color: var(--blue-active); background: #f0f7ff; }

        .category-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .tab { padding: 8px 16px; background: white; border-radius: 20px; border: 1px solid #eee; font-size: 13px; cursor: pointer; }
        .tab.active { background: var(--primary-orange); color: white; border-color: var(--primary-orange); }

        /* Book Card */
        .book-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .book-card { background: white; border-radius: var(--border-radius); overflow: hidden; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; }
        .book-cover-placeholder { height: 160px; background: #eaecf0; display: flex; align-items: center; justify-content: center; font-size: 50px; color: #adb5bd; }
        .book-info { padding: 10px; }
        .book-tag { font-size: 10px; background: #fff3e0; color: #e67e22; padding: 2px 6px; border-radius: 10px; }
        .book-title { font-size: 13px; font-weight: bold; margin: 5px 0; min-height: 2.6em; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .book-author { font-size: 11px; color: var(--text-sub); }
        .book-status-select { width: 100%; margin-top: 8px; padding: 6px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; font-size: 12px; }
        .delete-icon { position: absolute; top: 10px; right: 10px; background: white; color: #e74c3c; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; z-index: 10; cursor: pointer; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: white; width: 90%; max-width: 400px; border-radius: 24px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-weight: bold; font-size: 20px; margin-bottom: 20px; text-align: left; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #eee; box-sizing: border-box; font-size: 16px; }
        .form-group input:focus { border-color: var(--accent-yellow); outline: none; }
        
        /* Segmented Control (Status Buttons) */
        .segmented-control { display: flex; gap: 8px; background: #f5f5f5; padding: 5px; border-radius: 15px; }
        .segment { flex: 1; text-align: center; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; color: #666; transition: 0.2s; }
        .segment.active { background: var(--blue-active); color: white; }

        /* Sort Options */
        .sort-option { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px solid #eee; cursor: pointer; font-size: 16px; }
        .sort-option:last-child { border-bottom: none; }
        .radio-circle { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%; position: relative; }
        .sort-option.active .radio-circle { border-color: var(--primary-green); }
        .sort-option.active .radio-circle::after { content: ''; position: absolute; width: 12px; height: 12px; background: var(--primary-green); border-radius: 50%; top: 5px; left: 5px; }

        /* Detail Modal Specific */
        .detail-box { background: #f8faff; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .detail-title-large { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: var(--text-main); }
        .stars { display: flex; gap: 8px; margin: 15px 0; font-size: 32px; color: #ddd; }
        .stars span.active { color: var(--accent-yellow); }
        .fav-row { display: flex; align-items: center; gap: 10px; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #eee; cursor: pointer; }
        .fav-row input { width: auto; }

        .modal-footer { display: flex; gap: 12px; margin-top: 25px; }
        .btn-confirm { flex: 2; background: var(--primary-orange); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-cancel { flex: 1; background: #eee; border: none; padding: 15px; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .btn-save-green { width: 100%; background: var(--primary-green); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: bold; font-size: 16px; cursor: pointer; }

    </style>
</head>
<body>

<div class="header">
    <h1>èª­æ›¸è¨˜éŒ²</h1>
    <div class="header-btns">
        <button class="btn-icon" id="open-goal-btn" style="color:var(--primary-green)">ğŸ¯</button>
        <button class="btn-icon" style="color: #9b59b6;">â†“</button>
        <button class="btn-add" id="open-add-btn">ï¼‹ è¿½åŠ </button>
    </div>
</div>

<div class="goal-card" id="goal-card-trigger">
    <div class="goal-header">
        <span>ğŸ¯ å¹´é–“ç›®æ¨™: <span id="display-target">100</span>å†Š</span>
        <span id="display-progress-text">0/100 (0%)</span>
    </div>
    <div class="progress-bg"><div id="display-progress-fill" class="progress-fill" style="width: 0%"></div></div>
</div>

<div class="stats-grid">
    <div class="stat-box" style="background:#e8f8f0"><span class="stat-num" id="stat-read" style="color:#27ae60">0</span><span class="stat-label">èª­äº†</span></div>
    <div class="stat-box" style="background:#eef2ff"><span class="stat-num" id="stat-reading" style="color:#3b82f6">0</span><span class="stat-label">èª­æ›¸ä¸­</span></div>
    <div class="stat-box" style="background:#f8f9fa"><span class="stat-num" id="stat-want">0</span><span class="stat-label">èª­ã¿ãŸã„</span></div>
</div>
<div class="stats-sub">
    <div class="stat-box" style="background:#f5f0ff"><span class="stat-num" id="stat-pages" style="color:#9b59b6">0</span><span class="stat-label">ç·ãƒšãƒ¼ã‚¸æ•°</span></div>
    <div class="stat-box" style="background:#fff0f5"><span class="stat-num" id="stat-fav" style="color:#e91e63">0</span><span class="stat-label">ãŠæ°—ã«å…¥ã‚Š</span></div>
</div>

<input type="text" class="search-bar" id="search-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…ã§æ¤œç´¢...">

<button class="sort-trigger" id="sort-trigger">ç™»éŒ²æ—¥é †</button>

<div class="category-tabs" id="category-tabs">
    <div class="tab active">å…¨ã¦</div>
    <div class="tab">å°èª¬</div>
    <div class="tab">ãƒ“ã‚¸ãƒã‚¹</div>
    <div class="tab">æŠ€è¡“æ›¸</div>
    <div class="tab">ã‚¨ãƒƒã‚»ã‚¤</div>
    <div class="tab">ãã®ä»–</div>
    <div class="tab">+ è¿½åŠ </div>
</div>

<div class="book-grid" id="book-grid"></div>

<div id="modal-add" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">æœ¬ã‚’è¿½åŠ </div>
        <div class="form-group">
            <label>ã‚¿ã‚¤ãƒˆãƒ« <span style="color:red">*</span></label>
            <input type="text" id="add-title" placeholder="ä¾‹ï¼šãƒãƒ«ã‚¦ã‚§ã‚¤ã®æ£®">
        </div>
        <div class="form-group">
            <label>è‘—è€… <span style="color:red">*</span></label>
            <input type="text" id="add-author" placeholder="ä¾‹ï¼šæ‘ä¸Šæ˜¥æ¨¹">
        </div>
        <div style="display:flex; gap:10px">
            <div class="form-group" style="flex:1">
                <label>ãƒšãƒ¼ã‚¸æ•°</label>
                <input type="number" id="add-pages" placeholder="350">
            </div>
            <div class="form-group" style="flex:1">
                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="add-category">
                    <option>ãã®ä»–</option><option>å°èª¬</option><option>ãƒ“ã‚¸ãƒã‚¹</option><option>æŠ€è¡“æ›¸</option><option>ã‚¨ãƒƒã‚»ã‚¤</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <div class="segmented-control" id="add-status-segments">
                <div class="segment active" data-val="reading">èª­æ›¸ä¸­</div>
                <div class="segment" data-val="want">èª­ã¿ãŸã„</div>
                <div class="segment" data-val="read">èª­äº†</div>
            </div>
        </div>
        <div class="form-group">
            <label>è¡¨ç´™ç”»åƒURLï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="add-image" placeholder="ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚OK">
        </div>
        <div class="modal-footer">
            <button class="btn-confirm" id="save-book-btn">è¿½åŠ </button>
            <button class="btn-cancel" onclick="closeAllModals()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="modal-goal" class="modal-overlay">
    <div class="modal" style="text-align:center">
        <div class="modal-title">å¹´é–“ç›®æ¨™</div>
        <div class="form-group">
            <input type="number" id="input-goal" value="100" style="text-align:center; font-size:24px; font-weight:bold">
        </div>
        <button class="btn-save-green" id="save-goal-btn">ä¿å­˜</button>
    </div>
</div>

<div id="modal-sort" class="modal-overlay">
    <div class="modal">
        <div class="sort-option" data-sort="ç™»éŒ²æ—¥é †"><span>ç™»éŒ²æ—¥é †</span><div class="radio-circle"></div></div>
        <div class="sort-option" data-sort="ã‚¿ã‚¤ãƒˆãƒ«é †"><span>ã‚¿ã‚¤ãƒˆãƒ«é †</span><div class="radio-circle"></div></div>
        <div class="sort-option" data-sort="è‘—è€…é †"><span>è‘—è€…é †</span><div class="radio-circle"></div></div>
        <div class="sort-option" data-sort="è©•ä¾¡é †"><span>è©•ä¾¡é †</span><div class="radio-circle"></div></div>
    </div>
</div>

<div id="modal-detail" class="modal-overlay">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <div id="detail-header-title" style="font-weight:bold; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; width:70%"></div>
            <div style="display:flex; gap:10px">
                <button class="btn-icon" style="font-size:16px">âœ</button>
                <button class="btn-icon" onclick="closeAllModals()" style="font-size:16px">âœ•</button>
            </div>
        </div>
        <div class="detail-box">
            <div class="detail-title-large" id="detail-title"></div>
            <div style="font-size:14px; color:#555; line-height:1.8">
                <div>è‘—è€…: <span id="detail-author" style="font-weight:bold"></span></div>
                <div>ãƒšãƒ¼ã‚¸æ•°: <span id="detail-pages"></span></div>
                <div>ã‚«ãƒ†ã‚´ãƒª: <span id="detail-category"></span></div>
                <div>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="detail-status"></span></div>
            </div>
        </div>
        <label style="font-size:13px; font-weight:bold">è©•ä¾¡</label>
        <div class="stars" id="detail-stars">
            <span data-idx="1">â˜…</span><span data-idx="2">â˜…</span><span data-idx="3">â˜…</span><span data-idx="4">â˜…</span><span data-idx="5">â˜…</span>
        </div>
        <div class="fav-row" id="fav-toggle-area">
            <input type="checkbox" id="detail-fav-check"> <span style="font-size:18px">â™¡</span> ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ 
        </div>
        <div class="form-group" style="margin-top:20px">
            <label>ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
            <textarea id="detail-memo" rows="4" placeholder="ã“ã®æœ¬ã®æ„Ÿæƒ³ã‚„ãƒ¡ãƒ¢ã‚’æ›¸ã..."></textarea>
        </div>
        <button class="btn-save-green" id="save-detail-btn">ä¿å­˜</button>
    </div>
</div>

<script>
    // --- çŠ¶æ…‹ç®¡ç† ---
    let state = {
        books: JSON.parse(localStorage.getItem('books_v3')) || [],
        goal: parseInt(localStorage.getItem('goal_v3')) || 100,
        filter: 'å…¨ã¦',
        sort: 'ç™»éŒ²æ—¥é †',
        editingId: null
    };

    // --- ã‚»ãƒ¬ã‚¯ã‚¿ ---
    const $ = id => document.getElementById(id);

    // --- åˆæœŸåŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        initEvents();
        refreshUI();
    });

    function initEvents() {
        // ãƒœã‚¿ãƒ³é¡
        $('open-add-btn').onclick = () => openModal('modal-add');
        $('open-goal-btn').onclick = () => openModal('modal-goal');
        $('goal-card-trigger').onclick = () => openModal('modal-goal');
        $('sort-trigger').onclick = () => openModal('modal-sort');
        
        // ä¿å­˜å‡¦ç†
        $('save-book-btn').onclick = saveNewBook;
        $('save-goal-btn').onclick = saveGoal;
        $('save-detail-btn').onclick = saveDetailChanges;

        // æ¤œç´¢
        $('search-input').oninput = refreshUI;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.onclick = (e) => { if(e.target === overlay) closeAllModals(); };
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('#add-status-segments .segment').forEach(seg => {
            seg.onclick = () => {
                document.querySelectorAll('#add-status-segments .segment').forEach(s => s.classList.remove('active'));
                seg.classList.add('active');
            };
        });

        // ã‚½ãƒ¼ãƒˆé¸æŠ
        document.querySelectorAll('.sort-option').forEach(opt => {
            opt.onclick = () => {
                state.sort = opt.dataset.sort;
                $('sort-trigger').innerText = state.sort;
                $('sort-trigger').classList.add('sort-active-border');
                closeAllModals();
                refreshUI();
            };
        });

        // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                if(tab.innerText === '+ è¿½åŠ ') return;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.filter = tab.innerText;
                refreshUI();
            };
        });

        // æ˜Ÿè©•ä¾¡
        document.querySelectorAll('#detail-stars span').forEach((star, i) => {
            star.onclick = () => setStarRating(i + 1);
        });
    }

    // --- ãƒ­ã‚¸ãƒƒã‚¯ ---

    function openModal(id) { $(id).style.display = 'flex'; }
    function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }

    function saveGoal() {
        state.goal = parseInt($('input-goal').value) || 100;
        localStorage.setItem('goal_v3', state.goal);
        closeAllModals();
        refreshUI();
    }

    function saveNewBook() {
        const title = $('add-title').value;
        const author = $('add-author').value;
        if(!title || !author) { alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨è‘—è€…ã¯å¿…é ˆã§ã™"); return; }

        const newBook = {
            id: Date.now(),
            title, author,
            pages: $('add-pages').value || 0,
            category: $('add-category').value,
            status: document.querySelector('#add-status-segments .segment.active').dataset.val,
            image: $('add-image').value,
            rating: 0,
            isFavorite: false,
            memo: '',
            createdAt: new Date().toISOString()
        };

        state.books.push(newBook);
        saveToStorage();
        closeAllModals();
        clearAddForm();
        refreshUI();
    }

    function saveToStorage() {
        localStorage.setItem('books_v3', JSON.stringify(state.books));
    }

    function clearAddForm() {
        $('add-title').value = ''; $('add-author').value = ''; $('add-pages').value = ''; $('add-image').value = '';
    }

    function refreshUI() {
        updateStats();
        renderBookList();
        updateSortUI();
    }

    function updateStats() {
        const readCount = state.books.filter(b => b.status === 'read').length;
        $('display-target').innerText = state.goal;
        $('stat-read').innerText = readCount;
        $('stat-reading').innerText = state.books.filter(b => b.status === 'reading').length;
        $('stat-want').innerText = state.books.filter(b => b.status === 'want').length;
        $('stat-pages').innerText = state.books.reduce((sum, b) => sum + Number(b.pages), 0);
        $('stat-fav').innerText = state.books.filter(b => b.isFavorite).length;

        const percent = Math.min(Math.round((readCount / state.goal) * 100), 100);
        $('display-progress-fill').style.width = percent + '%';
        $('display-progress-text').innerText = `${readCount}/${state.goal} (${percent}%)`;
    }

    function updateSortUI() {
        document.querySelectorAll('.sort-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.sort === state.sort);
        });
    }

    function renderBookList() {
        const grid = $('book-grid');
        const query = $('search-input').value.toLowerCase();
        grid.innerHTML = '';

        let filtered = state.books.filter(b => {
            const matchCat = (state.filter === 'å…¨ã¦' || b.category === state.filter);
            const matchSearch = (b.title.toLowerCase().includes(query) || b.author.toLowerCase().includes(query));
            return matchCat && 
